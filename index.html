<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SPECTRE VIS-OPS</title>
    <style>
        :root { 
            --bg: #0f1113; 
            --card: #1c1f23; 
            --accent: #ff9500; /* Spectre Orange */
            --text: #e0e0e0; 
            --dim: #8e8e93; 
            --warning: #ff3b30; 
            --ares: #007aff;
            --success: #34c759;
            --medical: #ff3b30;
            --header-main: #ffffff;
            --grey-btn: #3a3f44;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px 15px 100px 15px; 
            line-height: 1.4;
        }
        
        .cache-warning { 
            background: var(--warning); 
            color: #fff; 
            padding: 6px 10px; 
            border-radius: 6px; 
            font-size: 9px; 
            font-weight: 700; 
            text-align: center; 
            margin-bottom: 15px; 
            text-transform: uppercase;
            border: 1px solid rgba(255,255,255,0.2);
            letter-spacing: 0.5px;
        }
        
        header { position: relative; }
        h1 { color: var(--accent); margin: 0; font-size: 28px; letter-spacing: 3px; font-weight: 900; }
        .squad-name { font-size: 14px; color: var(--dim); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; font-weight: 600; }
        
        .med-trigger {
            position: absolute;
            right: 0;
            top: 5px;
            background: var(--medical);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 59, 48, 0.4);
            animation: pulse-med 2s infinite;
        }
        @keyframes pulse-med {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); }
        }

        .section-label { 
            font-size: 11px; 
            color: var(--header-main); 
            text-transform: uppercase; 
            margin: 25px 0 8px 5px; 
            font-weight: 900; 
            letter-spacing: 1.5px; 
        }
        
        .category-trigger { background: var(--card); border-radius: 14px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); border: 1px solid #333; }
        
        .category-trigger summary { 
            padding: 16px; 
            font-weight: 700; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            list-style: none; 
            color: var(--accent); 
            align-items: center; 
        }
        .category-trigger summary::after { content: '‚ñº'; font-size: 10px; color: var(--accent); transition: transform 0.2s; }
        .category-trigger[open] summary::after { transform: rotate(180deg); }
        .category-content { border-top: 1px solid #333; }

        .mission-item { padding: 15px; border-bottom: 1px solid #333; position: relative; }
        .mission-item:last-child { border-bottom: none; }
        .mission-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        
        .status-pill { 
            font-size: 9px; 
            padding: 3px 6px; 
            border-radius: 4px; 
            font-weight: 900; 
            cursor: pointer;
            text-transform: uppercase;
        }
        .status-in-play { background: rgba(255, 149, 0, 0.1); color: var(--accent); border: 1px solid var(--accent); }
        .status-completed { background: var(--success); color: #000; }
        .status-failed { background: var(--medical); color: #fff; }
        
        .btn-add-mission { background: #2c2f33; color: var(--accent); border: 1px dashed var(--accent); padding: 10px; width: 100%; border-radius: 8px; font-weight: 800; margin: 10px 0; font-size: 12px; cursor: pointer; }
        .mission-delete { color: var(--dim); font-size: 12px; border: none; background: none; padding: 5px; cursor: pointer; }

        .card { background: var(--card); border-radius: 14px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); overflow: hidden; border: 1px solid #333; }
        
        .row { display: flex; align-items: center; padding: 14px 16px; border-bottom: 1px solid #333; gap: 10px; }
        .row:last-child { border-bottom: none; }
        
        input, textarea { 
            background: #2c2f33; 
            border: 1px solid #444; 
            color: #fff; 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 15px; 
            width: 100%; 
            outline: none; 
        }
        input:focus { border-color: var(--accent); }
        
        .ares-link { 
            background: var(--ares); 
            color: white; 
            text-decoration: none; 
            display: block; 
            text-align: center; 
            padding: 14px; 
            font-weight: 800; 
            border-radius: 10px; 
            margin-bottom: 10px;
        }
        
        .roster-header { display: grid; grid-template-columns: 100px 1fr 50px; font-size: 10px; color: var(--dim); padding: 0 16px; margin-bottom: 4px; font-weight: 800; }
        .roster-row { display: grid; grid-template-columns: 100px 1fr 50px; gap: 8px; padding: 12px 16px; border-bottom: 1px solid #333; align-items: center; }
        
        .roster-row.jtf { display: flex; gap: 12px; width: 100%; }
        .roster-row.jtf .jtf-callsign-input { width: 80px; background: transparent; border: none; padding: 0; font-weight: 900; color: var(--accent); text-transform: uppercase; }
        .roster-row.jtf .jtf-role-input { flex-grow: 1; }
        .roster-row.jtf .jtf-ch-input { width: 45px; text-align: center; }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn { background: var(--accent); color: #000; border: none; padding: 15px; border-radius: 10px; font-weight: 800; width: 100%; font-size: 14px; cursor: pointer; }
        
        .btn-sync { background: var(--grey-btn); color: var(--dim); border: 1px solid #444; }
        .btn-sync.modified { background: var(--accent); color: #000; border-color: var(--accent); }
        .btn-sync.synced { background: var(--success); color: #000; border-color: var(--success); }

        .sync-info { display: flex; flex-direction: column; gap: 4px; }
        .sync-timestamp { font-size: 9px; color: var(--dim); font-weight: 800; text-transform: uppercase; text-align: center; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.92);
            z-index: 9999;
            padding: 20px;
            align-items: center;
            justify-content: center;
        }
        .modal-body {
            background: var(--card);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--accent);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-title { font-weight: 800; color: var(--accent); margin-bottom: 15px; text-transform: uppercase; font-size: 14px; text-align: center; }
        
        #cloud_status { font-size: 9px; color: var(--dim); text-align: right; margin-top: 4px; font-weight: 700; text-transform: uppercase; }
        .cloud-online { color: var(--success) !important; }
        .cloud-offline { color: var(--warning) !important; }
    </style>
</head>
<body>

<div class="cache-warning">‚ö†Ô∏è DO NOT CLEAR CACHE - DATA IS OFFLINE ONLY ‚ö†Ô∏è</div>

<header>
    <h1>SPECTRE</h1>
    <div class="squad-name">Loyal Serpent 8 | VIS-OPS & Comms Specialist</div>
    <div id="cloud_status">Cloud: Checking...</div>
    <button class="med-trigger" onclick="window.openModal('medical_modal')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z"/></svg>
    </button>
</header>

<div class="section-label">üìù Field Intel / Orders</div>
<details class="category-trigger" open>
    <summary>Mission Intelligence</summary>
    <div class="category-content">
        <div id="mission_container"></div>
        <div style="padding: 0 15px 15px 15px;">
            <button class="btn-add-mission" id="add_mission_btn">+ ADD NEW OBJECTIVE</button>
        </div>
    </div>
</details>

<div class="section-label">üìç Ares Alpha Tracking</div>
<details class="category-trigger">
    <summary>Live Battle Map</summary>
    <div class="category-content">
        <div style="padding:15px;">
            <a href="https://ares-alpha.com/" target="_blank" class="ares-link">OPEN ARES ALPHA WEB</a>
            <div class="row" style="padding:10px 0 0 0;"><span>Team ID</span><input type="text" id="ares_id" class="save" placeholder="Spectre-Main"></div>
            <div class="row" style="padding:10px 0 0 0;"><span>Join Code</span><input type="text" id="ares_pass" class="save" placeholder="Passcode"></div>
        </div>
    </div>
</details>

<div class="section-label">üë• Spectre Roster</div>
<details class="category-trigger">
    <summary>Squad Roster</summary>
    <div class="category-content">
        <div class="roster-header"><span>CALLSIGN</span><span>ROLE(S)</span><span>CH#</span></div>
        <div id="roster">
            <div class="roster-row"><b>Manchild</b><input type="text" id="r1" class="save" value="Squad Leader"> <input type="text" id="n1" class="save" value="01"></div>
            <div class="roster-row"><b>Ribs</b><input type="text" id="r2" class="save" value="Rifleman"> <input type="text" id="n2" class="save" value="02"></div>
            <div class="roster-row"><b>SIXX</b><input type="text" id="r3" class="save" value="Sniper"> <input type="text" id="n3" class="save" value="03"></div>
            <div class="roster-row"><b>Razor</b><input type="text" id="r4" class="save" value="LMG / DMR"> <input type="text" id="n4" class="save" value="04"></div>
            <div class="roster-row"><b>Danger</b><input type="text" id="r5" class="save" value="Rifleman"> <input type="text" id="n5" class="save" value="05"></div>
            <div class="roster-row"><b>Coldsmoke</b><input type="text" id="r6" class="save" value="Rifleman / LMG"> <input type="text" id="n6" class="save" value="06"></div>
            <div class="roster-row"><b>FOX</b><input type="text" id="r7" class="save" value="COMCAM / VIS"> <input type="text" id="n7" class="save" value="07"></div>
        </div>
    </div>
</details>

<div class="section-label">ü§ù JTF / Guest Roster</div>
<details class="category-trigger" open>
    <summary>External Personnel</summary>
    <div class="category-content">
        <div id="jtf_roster"></div>
        <div style="padding: 0 15px 15px 15px;">
            <button class="btn-add-mission" id="add_jtf_btn">+ ADD GUEST ROSTER</button>
        </div>
    </div>
</details>

<div class="btn-group">
    <button class="btn" id="export_btn">Copy Data</button>
    <div class="sync-info">
        <button class="btn btn-sync" id="btn_cloud_sync">Sync Cloud</button>
        <span class="sync-timestamp" id="sync_time">Last Sync: Never</span>
    </div>
</div>

<div id="medical_modal" class="modal-overlay">
    <div class="modal-body">
        <div class="modal-title">MED-EVAC INFO</div>
        <div id="med_list"></div>
        <button class="btn btn-sync" id="close_med_btn" style="margin-top:10px;">Close</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE CONFIG ---
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'spectre-ops-prd';

    // --- APP STATE ---
    let missions = [];
    let jtfMembers = [];
    let user = null;
    let isRemoteUpdate = false;

    // --- UI HELPERS ---
    const setSyncUI = (state) => {
        const btn = document.getElementById('btn_cloud_sync');
        if (state === 'modified') {
            btn.classList.remove('synced');
            btn.classList.add('modified');
            btn.innerText = 'SYNC CLOUD*';
        } else if (state === 'synced') {
            btn.classList.remove('modified');
            btn.classList.add('synced');
            btn.innerText = 'CLOUD SYNCED';
            document.getElementById('sync_time').innerText = `Last Sync: ${new Date().toLocaleTimeString()}`;
        }
    };

    const renderMissions = () => {
        const container = document.getElementById('mission_container');
        container.innerHTML = '';
        missions.forEach(m => {
            const div = document.createElement('div');
            const map = { play: ['IN PLAY', 'status-in-play'], completed: ['COMPLETED', 'status-completed'], failed: ['FAILED', 'status-failed'] };
            div.className = 'mission-item';
            div.innerHTML = `
                <div class="mission-header">
                    <div class="status-pill ${map[m.status][1]}" data-id="${m.id}" data-action="toggle">${map[m.status][0]}</div>
                    <button class="mission-delete" data-id="${m.id}" data-action="delete">‚úï</button>
                </div>
                <textarea data-id="${m.id}" placeholder="Objective details..." rows="2">${m.text}</textarea>
            `;
            
            div.querySelector('textarea').addEventListener('input', (e) => {
                const target = missions.find(x => x.id == e.target.dataset.id);
                if (target) target.text = e.target.value;
                saveLocal();
            });
            
            div.querySelector('.status-pill').addEventListener('click', (e) => {
                const target = missions.find(x => x.id == e.target.dataset.id);
                if (target) {
                    const cycles = { play: 'completed', completed: 'failed', failed: 'play' };
                    target.status = cycles[target.status];
                }
                renderMissions();
                saveLocal();
            });

            div.querySelector('.mission-delete').addEventListener('click', (e) => {
                missions = missions.filter(x => x.id != e.target.dataset.id);
                renderMissions();
                saveLocal();
            });

            container.appendChild(div);
        });
    };

    const renderJTF = () => {
        const container = document.getElementById('jtf_roster');
        container.innerHTML = '';
        jtfMembers.forEach(m => {
            const row = document.createElement('div');
            row.className = 'roster-row jtf';
            row.innerHTML = `
                <input type="text" class="jtf-callsign-input" value="${m.callsign}" placeholder="CALLSIGN" data-id="${m.id}" data-field="callsign">
                <input type="text" class="jtf-role-input" value="${m.role}" placeholder="Role/Unit" data-id="${m.id}" data-field="role">
                <input type="text" class="jtf-ch-input" value="${m.ch}" placeholder="00" data-id="${m.id}" data-field="ch">
                <button data-id="${m.id}" class="jtf-del" style="color:var(--medical); border:none; background:none; cursor:pointer;">‚úï</button>
            `;
            
            row.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const member = jtfMembers.find(x => x.id == e.target.dataset.id);
                    if (member) member[e.target.dataset.field] = e.target.value;
                    saveLocal();
                });
            });

            row.querySelector('.jtf-del').addEventListener('click', (e) => {
                jtfMembers = jtfMembers.filter(x => x.id != e.target.dataset.id);
                renderJTF();
                saveLocal();
            });

            container.appendChild(row);
        });
    };

    // --- DATA ACTIONS ---
    const saveLocal = () => {
        if (isRemoteUpdate) return;
        localStorage.setItem('spectre_missions', JSON.stringify(missions));
        localStorage.setItem('spectre_jtf', JSON.stringify(jtfMembers));
        setSyncUI('modified');
        syncToCloud();
    };

    const syncToCloud = async (manual = false) => {
        if (!user) return;
        try {
            const data = {
                missions,
                jtf: jtfMembers,
                ts: Date.now(),
                sender: user.uid
            };
            // Mandatory Rule 1 Path
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'v1', 'state'), data, { merge: true });
            setSyncUI('synced');
        } catch (e) { console.error("Sync Error:", e); }
    };

    // --- GLOBAL ATTACHMENTS (Ensures button clicks work in live) ---
    window.openModal = (id) => document.getElementById(id).style.display = 'flex';
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';

    // --- INITIALIZATION ---
    async function init() {
        // 1. Auth First (Rule 3)
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                user = (await signInWithCustomToken(auth, __initial_auth_token)).user;
            } else {
                user = (await signInAnonymously(auth)).user;
            }
            document.getElementById('cloud_status').innerText = 'Cloud: Online';
            document.getElementById('cloud_status').classList.add('cloud-online');

            // 2. Real-time Cloud Sync
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'v1', 'state'), (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.sender !== user.uid) {
                        isRemoteUpdate = true;
                        missions = data.missions || [];
                        jtfMembers = data.jtf || [];
                        renderMissions();
                        renderJTF();
                        localStorage.setItem('spectre_missions', JSON.stringify(missions));
                        localStorage.setItem('spectre_jtf', JSON.stringify(jtfMembers));
                        setSyncUI('synced');
                        isRemoteUpdate = false;
                    }
                }
            }, (err) => console.error("Snapshot Error:", err));
        } catch (e) {
            document.getElementById('cloud_status').innerText = 'Cloud: Offline';
            document.getElementById('cloud_status').classList.add('cloud-offline');
        }

        // 3. Load Local Cache
        const localMissions = localStorage.getItem('spectre_missions');
        if (localMissions) missions = JSON.parse(localMissions);
        const localJTF = localStorage.getItem('spectre_jtf');
        if (localJTF) jtfMembers = JSON.parse(localJTF);

        renderMissions();
        renderJTF();

        // 4. Attach Main Button Listeners (Avoids inline onclick issues)
        document.getElementById('add_mission_btn').addEventListener('click', () => {
            missions.push({ id: Date.now(), text: '', status: 'play' });
            renderMissions();
            saveLocal();
        });

        document.getElementById('add_jtf_btn').addEventListener('click', () => {
            jtfMembers.push({ id: Date.now(), callsign: '', role: '', ch: '' });
            renderJTF();
            saveLocal();
        });

        document.getElementById('btn_cloud_sync').addEventListener('click', () => syncToCloud(true));
        
        document.getElementById('export_btn').addEventListener('click', () => {
            const data = { missions, jtf: jtfMembers, roster: {} };
            document.querySelectorAll('.save').forEach(el => data.roster[el.id] = el.value);
            const text = JSON.stringify(data);
            const dummy = document.createElement("textarea");
            document.body.appendChild(dummy);
            dummy.value = text;
            dummy.select();
            document.execCommand("copy");
            document.body.removeChild(dummy);
            alert("TACTICAL DATA COPIED TO CLIPBOARD");
        });

        document.getElementById('close_med_btn').addEventListener('click', () => window.closeModal('medical_modal'));

        // 5. Handle Static Roster Fields
        document.querySelectorAll('.save').forEach(el => {
            const saved = localStorage.getItem('spectre_' + el.id);
            if (saved) el.value = saved;
            el.addEventListener('input', () => {
                localStorage.setItem('spectre_' + el.id, el.value);
                setSyncUI('modified');
                syncToCloud();
            });
        });
    }

    window.addEventListener('load', init);
</script>
</body>
</html>
